<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>FF14 Mini Cactpot Solver</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; 
            background-color: #1a0b2e;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            /* 賭場地毯紋路 */
            background-size: 100% 100%;
        }
        
        .casino-pattern {
            background-image: radial-gradient(#ffffff 1px, transparent 1px), radial-gradient(#ffffff 1px, transparent 1px);
            background-position: 0 0, 25px 25px;
            background-size: 50px 50px;
            opacity: 0.05;
        }

        .select-none { user-select: none; -webkit-user-select: none; }
        
        /* 自定義捲軸 - 金色風格 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #2d1b4e; }
        ::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #fcd34d; }

        /* 3D 按鈕效果 */
        .btn-3d {
            transition: all 0.1s;
            box-shadow: 0px 4px 0px 0px rgba(0,0,0,0.5);
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.5);
        }
        
        /* 金屬文字效果 */
        .text-gold {
            background: linear-gradient(to bottom, #fcd34d, #d4af37, #b45309);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0px 2px 0px rgba(0,0,0,0.5));
        }

        .border-gold {
            border-image: linear-gradient(to bottom, #fcd34d, #b45309) 1;
        }
    </style>
</head>
<body class="text-white min-h-screen relative overflow-x-hidden">

    <div class="fixed inset-0 casino-pattern pointer-events-none z-0"></div>

    <div id="root" class="relative z-10"></div>

    <script type="text/babel">
        // ★★★ 請在每次 GIT 更新代碼時，手動修改此處的時間 ★★★
        const BUILD_DATE = "2024.12.12 00:35"; 

        const { useState, useEffect, useMemo, useRef } = React;

        // --- Localization Dictionary ---
        const LOCALE = {
            zh: {
                title: "仙人微彩模擬器",
                sum: "總和",
                payout_title: "獎金一覽表",
                close_hint: "點擊背景關閉",
                select_num: "選擇數字",
                clear_cell: "清除此格",
                analysis_title: "全方案風險分析",
                click_hint: "(點擊行查看詳細機率)",
                best_pick: "最佳推薦",
                rank: "Rank",
                guaranteed: "保底",
                view_details: "查看詳細機率",
                reset: "重置",
                payout_btn: "獎金表",
                mode_on: "全填模式 (開啟)",
                mode_off: "全填模式 (鎖定)",
                filled_status: "已填寫 {n}/9 格",
                reveal: "揭開",
                row: "橫排",
                col: "直排",
                diag: "對角",
                label_10k: "1萬",
                label_3600: "3千6",
                ver: "版本"
            },
            en: {
                title: "Mini Cactpot Solver",
                sum: "Sum",
                payout_title: "Payout Table",
                close_hint: "Tap background to close",
                select_num: "Select Number",
                clear_cell: "Clear Cell",
                analysis_title: "Risk Analysis",
                click_hint: "(Tap row for details)",
                best_pick: "Recommended",
                rank: "Rank",
                guaranteed: "Guaranteed",
                view_details: "View Details",
                reset: "Reset",
                payout_btn: "Payouts",
                mode_on: "Edit Mode (ON)",
                mode_off: "Edit Mode (Unlock)",
                filled_status: "Filled {n}/9",
                reveal: "Reveal",
                row: "Row",
                col: "Col",
                diag: "Diag",
                label_10k: "10k",
                label_3600: "3.6k",
                ver: "Version"
            },
            ja: {
                title: "ミニ・くじテンダー",
                sum: "合計",
                payout_title: "賞金一覧",
                close_hint: "背景タップで閉じる",
                select_num: "数字を選択",
                clear_cell: "クリア",
                analysis_title: "全パターン分析",
                click_hint: "(行クリックで詳細)",
                best_pick: "推奨",
                rank: "順位",
                guaranteed: "確定",
                view_details: "詳細を見る",
                reset: "リセット",
                payout_btn: "賞金表",
                mode_on: "編集モード (ON)",
                mode_off: "編集モード (解除)",
                filled_status: "入力済み {n}/9",
                reveal: "めくる",
                row: "横",
                col: "縦",
                diag: "斜め",
                label_10k: "1万",
                label_3600: "3600",
                ver: "更新日"
            }
        };

        // --- Icons (SVG) ---
        const RefreshCw = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>;
        const Trophy = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
        const ChevronDown = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6"/></svg>;
        const Unlock = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>;
        const Lock = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const BookOpen = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>;
        const X = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const Sparkles = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>;

        // --- Logic Constants ---
        const PAYOUTS = {
            6: 10000, 7: 36, 8: 720, 9: 360, 10: 80,
            11: 252, 12: 108, 13: 72, 14: 54, 15: 180,
            16: 72, 17: 180, 18: 119, 19: 36, 20: 306,
            21: 1080, 22: 144, 23: 1800, 24: 3600,
        };

        const LINES = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], 
            [0, 3, 6], [1, 4, 7], [2, 5, 8], 
            [0, 4, 8], [2, 4, 6], 
        ];

        const LINE_ARROWS = ["➡", "➡", "➡", "⬇", "⬇", "⬇", "↘", "↙"];

        function getPermutations(arr) {
            if (arr.length === 0) return [[]];
            const firstEl = arr[0];
            const rest = arr.slice(1);
            const permsWithoutFirst = getPermutations(rest);
            const allPermutations = [];
            permsWithoutFirst.forEach((perm) => {
                for (let i = 0; i <= perm.length; i++) {
                allPermutations.push([...perm.slice(0, i), firstEl, ...perm.slice(i)]);
                }
            });
            return allPermutations;
        }

        // --- Components ---

        const PayoutTableModal = ({ isOpen, onClose, t }) => {
            if (!isOpen) return null;
            
            const sortedPayouts = Object.entries(PAYOUTS).sort((a,b) => Number(a[0]) - Number(b[0]));
            const midPoint = Math.ceil(sortedPayouts.length / 2);
            const leftCol = sortedPayouts.slice(0, midPoint);
            const rightCol = sortedPayouts.slice(midPoint);

            const RowItem = ({ sum, mgp }) => {
                const isHigh = mgp >= 1800;
                return (
                    <div className={`flex justify-between items-center p-2 rounded-lg h-9 border-b ${isHigh ? 'bg-gradient-to-r from-yellow-900/60 to-transparent border-yellow-600/50' : 'bg-black/30 border-white/5'}`}>
                        <span className="text-zinc-400 font-mono text-xs">{t('sum')} <span className="text-white font-bold">{sum}</span></span>
                        <span className={`font-bold text-sm ${isHigh ? 'text-[#fcd34d] drop-shadow' : 'text-zinc-300'}`}>
                            {mgp.toLocaleString()} <span className="text-[10px] text-zinc-500">MGP</span>
                        </span>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <div onClick={(e) => e.stopPropagation()} className="bg-[#2d1b4e] border-2 border-[#d4af37] rounded-xl w-full max-w-sm flex flex-col relative shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden">
                        <div className="p-4 border-b border-[#ffffff1a] flex items-center justify-between bg-black/40">
                            <h3 className="text-[#fcd34d] font-bold text-lg flex items-center gap-2 drop-shadow-md">
                                <Trophy className="w-5 h-5" /> {t('payout_title')}
                            </h3>
                            <button onClick={onClose} className="text-zinc-400 hover:text-white p-1 rounded-full hover:bg-white/10 transition-colors"><X className="w-6 h-6"/></button>
                        </div>
                        <div className="p-4 bg-[#2d1b4e]">
                            <div className="flex gap-4">
                                <div className="flex-1 space-y-1.5">
                                    {leftCol.map(([sum, mgp]) => <RowItem key={sum} sum={sum} mgp={mgp} />)}
                                </div>
                                <div className="flex-1 space-y-1.5">
                                    {rightCol.map(([sum, mgp]) => <RowItem key={sum} sum={sum} mgp={mgp} />)}
                                </div>
                            </div>
                        </div>
                        <div className="p-3 text-center text-xs text-zinc-500 border-t border-[#ffffff1a] bg-black/40">
                            {t('close_hint')}
                        </div>
                    </div>
                </div>
            );
        };

        const NumberSelector = ({ isOpen, onSelect, usedNumbers, currentValue, onClose, t }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-in fade-in duration-200" onClick={onClose}>
                <div onClick={(e) => e.stopPropagation()} className="bg-[#1a0b2e] border-2 border-[#d4af37] rounded-2xl shadow-[0_0_30px_rgba(212,175,55,0.3)] p-4 w-full max-w-[320px] grid grid-cols-3 gap-3">
                    <div className="col-span-3 text-center text-[#fcd34d] font-bold mb-2 uppercase tracking-widest text-sm drop-shadow">{t('select_num')}</div>
                    {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => {
                    const isUsed = usedNumbers.has(num) && num !== currentValue;
                    return (
                        <button
                        key={num}
                        disabled={isUsed}
                        onClick={() => onSelect(num)}
                        className={`
                            h-14 rounded-xl font-bold text-2xl flex items-center justify-center transition-all btn-3d
                            ${num === currentValue 
                                ? 'bg-gradient-to-br from-blue-500 to-blue-700 text-white ring-2 ring-white/50 border-b-4 border-blue-900' 
                                : isUsed 
                                    ? 'bg-zinc-800 text-zinc-600 border-b-4 border-black cursor-not-allowed shadow-none translate-y-[4px]' 
                                    : 'bg-gradient-to-br from-[#fcd34d] to-[#d4af37] text-black border-b-4 border-[#b45309] hover:brightness-110 active:border-b-0'
                            }
                        `}
                        >
                        {num}
                        </button>
                    );
                    })}
                    <button onClick={() => onSelect(null)} className="btn-3d col-span-3 h-10 mt-2 font-bold text-red-200 bg-gradient-to-r from-red-900 to-red-800 border-b-4 border-red-950 rounded-xl flex items-center justify-center uppercase tracking-wider active:border-b-0 transition-transform">{t('clear_cell')}</button>
                </div>
                </div>
            );
        };

        // Main App
        function MiniCactpotSolver() {
            const [lang, setLang] = useState('zh');
            const [board, setBoard] = useState(Array(9).fill(null));
            const [openSelectorIndex, setOpenSelectorIndex] = useState(null);
            const [isFullFillMode, setIsFullFillMode] = useState(false);
            const [showPayouts, setShowPayouts] = useState(false);
            
            const [solutions, setSolutions] = useState([]);
            const [bestLineIndex, setBestLineIndex] = useState(null);
            const [suggestedCellIndex, setSuggestedCellIndex] = useState(null);

            const t = (key) => LOCALE[lang][key] || key;

            const getLineName = (index) => {
                if (index <= 2) return `${t('row')} ${index + 1}`;
                if (index <= 5) return `${t('col')} ${index - 2}`;
                if (index === 6) return `${t('diag')} ↘`;
                if (index === 7) return `${t('diag')} ↙`;
                return "";
            };

            const filledCount = board.filter(n => n !== null).length;
            const isSelectionPhase = filledCount < 4; 
            const showAnalysis = !isSelectionPhase || isFullFillMode;

            const availableNumbers = useMemo(() => {
                const used = new Set(board.filter((n) => n !== null));
                return [1, 2, 3, 4, 5, 6, 7, 8, 9].filter((n) => !used.has(n));
            }, [board]);

            const usedNumbersSet = useMemo(() => new Set(board.filter((n) => n !== null)), [board]);

            useEffect(() => {
                const emptyIndices = board.map((val, idx) => (val === null ? idx : -1)).filter((idx) => idx !== -1);
                const perms = getPermutations(availableNumbers);
                
                const lineStats = LINES.map(() => ({ 
                    totalMGP: 0, 
                    chance10k: 0, 
                    chance3600: 0, 
                    counts: 0,
                    payoutDist: {}
                }));
                const cellImpactScore = Array(9).fill(0); 

                perms.forEach((perm) => {
                    const tempBoard = [...board];
                    perm.forEach((val, i) => tempBoard[emptyIndices[i]] = val);

                    LINES.forEach((lineIndices, lineId) => {
                        const sum = tempBoard[lineIndices[0]] + tempBoard[lineIndices[1]] + tempBoard[lineIndices[2]];
                        const payout = PAYOUTS[sum] || 0;
                        
                        lineStats[lineId].totalMGP += payout;
                        lineStats[lineId].counts++;
                        lineStats[lineId].payoutDist[payout] = (lineStats[lineId].payoutDist[payout] || 0) + 1;
                        
                        const isJackpot = sum === 6; 
                        const isSecond = sum === 24; 
                        
                        if (isJackpot) lineStats[lineId].chance10k++;
                        if (isSecond) lineStats[lineId].chance3600++;

                        if (isSelectionPhase && (isJackpot || isSecond)) {
                            lineIndices.forEach(cellIdx => {
                                if (board[cellIdx] === null) {
                                    cellImpactScore[cellIdx] += isJackpot ? 10 : 1; 
                                }
                            });
                        }
                    });
                });

                const results = lineStats.map(stat => {
                    if (stat.counts === 0) return { ev: 0, chance10k: 0, chance3600: 0, allProbs: [] };
                    
                    const allProbs = Object.entries(stat.payoutDist)
                        .map(([mgp, count]) => ({
                            mgp: parseInt(mgp),
                            percent: (count / stat.counts) * 100
                        }))
                        .filter(p => p.percent > 0) 
                        .sort((a, b) => b.mgp - a.mgp); 

                    return {
                        ev: Math.floor(stat.totalMGP / stat.counts),
                        chance10k: (stat.chance10k / stat.counts) * 100,
                        chance3600: (stat.chance3600 / stat.counts) * 100,
                        allProbs: allProbs
                    };
                });

                setSolutions(results);
                const maxEV = Math.max(...results.map(r => r.ev));
                setBestLineIndex(results.findIndex(r => r.ev === maxEV));

                if (isSelectionPhase && filledCount > 0) {
                    let maxScore = -1;
                    let bestCell = -1;
                    cellImpactScore.forEach((score, idx) => {
                        if (score > maxScore && board[idx] === null) maxScore = score, bestCell = idx;
                    });
                    if (bestCell === -1) {
                        const priority = [4, 0, 2, 6, 8, 1, 3, 5, 7];
                        bestCell = priority.find(idx => board[idx] === null) ?? -1;
                    }
                    setSuggestedCellIndex(bestCell);
                } else {
                    setSuggestedCellIndex(null);
                }
            }, [board, availableNumbers, filledCount, isSelectionPhase, isFullFillMode]);

            const handleSelect = (val) => {
                const newBoard = [...board];
                if (val !== null) {
                const existingIdx = newBoard.indexOf(val);
                if (existingIdx !== -1) newBoard[existingIdx] = null;
                }
                if (openSelectorIndex !== null) newBoard[openSelectorIndex] = val;
                setBoard(newBoard);
                setOpenSelectorIndex(null);
            };

            const handleReset = () => {
                setBoard(Array(9).fill(null));
                setOpenSelectorIndex(null);
            };

            const Indicator = ({ lineId, arrow }) => {
                if (!solutions[lineId]) return <div className="w-full h-full opacity-0"></div>;
                const { ev, chance10k } = solutions[lineId];
                const isBest = showAnalysis && lineId === bestLineIndex;
                const displayEv = ev >= 1000 ? (ev/1000).toFixed(1).replace('.0','') + 'k' : ev;

                return (
                <div className={`flex items-center justify-center w-full h-full p-0.5`}>
                    <div className={`
                    relative flex flex-col items-center justify-center w-[3rem] h-[3rem] rounded-full border-2 backdrop-blur-md transition-all duration-300 shadow-lg
                    ${isBest 
                        ? 'bg-gradient-to-b from-green-700 to-green-900 border-green-400 text-white shadow-[0_0_15px_rgba(74,222,128,0.6)] z-10 scale-110' 
                        : 'bg-black/50 border-[#ffffff1a] text-zinc-400'}
                    `}>
                    <span className={`text-[10px] md:text-xs font-bold leading-none flex items-center justify-center ${isBest ? 'text-white drop-shadow-md' : 'text-[#a1a1aa]'}`}>
                        <span className={`mr-[1px] ${isBest ? 'text-yellow-300' : 'text-[#d4af37]'}`}>$</span>
                        {displayEv}
                    </span>

                    {chance10k > 0 && (
                        <div className="absolute -top-1 -right-1">
                        <span className="flex h-2.5 w-2.5 relative">
                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                            <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-[#fcd34d] border border-white"></span>
                        </span>
                        </div>
                    )}
                    <div className={`text-xs mt-0.5 ${isBest ? 'text-white animate-pulse' : 'text-[#52525b]'}`}>
                        {arrow}
                    </div>
                    </div>
                </div>
                );
            };

            const GameCell = ({ idx }) => {
                const cellValue = board[idx];
                const isSuggested = isSelectionPhase && idx === suggestedCellIndex;
                const isLocked = !isFullFillMode && (cellValue === null && filledCount >= 4);

                return (
                    <button
                        disabled={isLocked}
                        onClick={() => setOpenSelectorIndex(idx)}
                        className={`
                            relative w-full h-full aspect-square rounded-xl flex flex-col items-center justify-center text-4xl md:text-5xl font-bold transition-all duration-150 group
                            border-2 shadow-inner overflow-hidden
                            ${cellValue !== null 
                                ? 'bg-gradient-to-br from-[#fef3c7] via-[#fcd34d] to-[#d97706] text-[#451a03] border-[#fcd34d] shadow-[inset_0_0_10px_rgba(180,83,9,0.4)]' 
                                : isLocked
                                    ? 'bg-[#0f0718] border-[#2d1b4e] cursor-not-allowed opacity-40'
                                    : 'bg-[#2d1b4e]/80 hover:bg-[#3b2166] text-transparent border-[#4c1d95] active:scale-95'
                            }
                            ${isSuggested && !cellValue ? 'ring-2 ring-offset-2 ring-offset-[#1a0b2e] ring-[#f0abfc] shadow-[0_0_20px_rgba(240,171,252,0.6)] z-20' : ''}
                        `}
                    >
                        {/* 裝飾線條 */}
                        {!cellValue && !isLocked && (
                            <div className="absolute inset-0 opacity-20 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPgo8cmVjdCB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMSIvPgo8cGF0aCBkPSJNTAgMEw4IiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMSIvPjwvc3ZnPg==')]"></div>
                        )}

                        {cellValue ? (
                            <span className="drop-shadow-sm font-serif">{cellValue}</span>
                        ) : (
                            !isLocked && <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center"><Sparkles className="w-4 h-4 text-white/20" /></div>
                        )}
                        
                        {isSuggested && !cellValue && (
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div className="bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-lg backdrop-blur-sm animate-pulse border border-white/20">
                                    {t('reveal')}
                                </div>
                            </div>
                        )}
                    </button>
                );
            }

            const AnalysisList = () => {
                if (!showAnalysis || solutions.length === 0) return null;

                const rankedSolutions = solutions
                    .map((sol, index) => ({ ...sol, originalIndex: index }))
                    .sort((a, b) => b.ev - a.ev);
                
                const [expandedLine, setExpandedLine] = useState(null);

                const toggleExpand = (idx) => {
                    setExpandedLine(expandedLine === idx ? null : idx);
                };

                return (
                    <div className="w-full max-w-[400px] mt-6 animate-in slide-in-from-bottom-4 fade-in duration-500">
                        <div className="flex items-center gap-2 mb-2 px-1">
                            <Sparkles className="w-4 h-4 text-[#d4af37]" />
                            <h3 className="text-[#fcd34d] font-bold text-sm tracking-wider uppercase drop-shadow">{t('analysis_title')}</h3>
                            <span className="text-[10px] text-zinc-400 ml-auto">{t('click_hint')}</span>
                        </div>
                        <div className="bg-[#2d1b4e]/60 backdrop-blur-md border border-[#ffffff1a] rounded-xl overflow-hidden divide-y divide-[#ffffff1a] shadow-xl">
                            {rankedSolutions.map((sol, rank) => {
                                const isBest = sol.originalIndex === bestLineIndex;
                                const name = getLineName(sol.originalIndex);
                                const arrow = LINE_ARROWS[sol.originalIndex];
                                const isExpanded = expandedLine === sol.originalIndex;
                                
                                const hasBigPrize = sol.chance10k > 0 || sol.chance3600 > 0;
                                const isGuaranteed = sol.allProbs.length === 1 && Math.round(sol.allProbs[0].percent) === 100;

                                return (
                                    <div key={sol.originalIndex} className="flex flex-col">
                                        <button 
                                            onClick={() => toggleExpand(sol.originalIndex)}
                                            className={`
                                                w-full flex items-center justify-between p-3 transition-colors text-left
                                                ${isBest ? 'bg-gradient-to-r from-green-900/40 to-transparent border-l-4 border-green-500' : 'hover:bg-white/5 border-l-4 border-transparent'}
                                                ${isExpanded ? 'bg-black/20' : ''}
                                            `}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-6 h-6 flex items-center justify-center rounded-full font-bold text-xs shadow-inner ${isBest ? 'bg-green-600 text-white' : 'bg-[#1a0b2e] text-zinc-500'}`}>
                                                    {arrow}
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className={`text-sm font-bold ${isBest ? 'text-green-300 drop-shadow' : 'text-zinc-300'}`}>{name}</span>
                                                    <span className="text-[10px] text-zinc-500 uppercase tracking-wider">{isBest ? t('best_pick') : `${t('rank')} #${rank+1}`}</span>
                                                </div>
                                            </div>
                                            
                                            <div className="text-right flex flex-col items-end">
                                                <span className={`font-bold font-mono text-sm ${isBest ? 'text-[#fcd34d]' : 'text-white'}`}>
                                                    ${Math.floor(sol.ev).toLocaleString()}
                                                </span>
                                                <div className="flex gap-2 text-[10px] mt-0.5 items-center">
                                                    {hasBigPrize ? (
                                                        <>
                                                            <span className={sol.chance10k > 0 ? 'text-[#fcd34d] font-bold' : 'text-zinc-600'}>
                                                                {t('label_10k')}: {sol.chance10k.toFixed(0)}%
                                                            </span>
                                                            <span className={sol.chance3600 > 0 ? 'text-blue-300' : 'text-zinc-600'}>
                                                                {t('label_3600')}: {sol.chance3600.toFixed(0)}%
                                                            </span>
                                                        </>
                                                    ) : isGuaranteed ? (
                                                        <span className="text-zinc-500">
                                                            {t('guaranteed')}: {sol.allProbs[0].mgp}
                                                        </span>
                                                    ) : (
                                                        <span className="text-zinc-600">{t('view_details')}</span>
                                                    )}
                                                    <ChevronDown className={`w-3 h-3 text-zinc-500 transition-transform ${isExpanded ? 'rotate-180' : ''}`}/>
                                                </div>
                                            </div>
                                        </button>

                                        {/* Expanded Details */}
                                        {isExpanded && (
                                            <div className="bg-black/30 p-3 shadow-inner border-t border-[#ffffff1a] animate-in slide-in-from-top-2 duration-200">
                                                <div className="grid grid-cols-3 gap-2">
                                                    {sol.allProbs.map((prob) => {
                                                        const isJackpot = prob.mgp === 10000;
                                                        const isSecond = prob.mgp === 3600;
                                                        const isHigh = prob.mgp >= 1000 && prob.mgp < 3600;
                                                        
                                                        let bgClass = "bg-[#1a0b2e] border-[#ffffff1a]";
                                                        let textClass = "text-zinc-400";

                                                        if (isJackpot) {
                                                            bgClass = "bg-gradient-to-br from-yellow-900/60 to-yellow-600/30 border-yellow-500/50";
                                                            textClass = "text-[#fcd34d]";
                                                        } else if (isSecond) {
                                                            bgClass = "bg-blue-900/30 border-blue-500/30";
                                                            textClass = "text-blue-200";
                                                        } else if (isHigh) {
                                                            bgClass = "bg-purple-900/30 border-purple-500/30";
                                                            textClass = "text-purple-200";
                                                        }

                                                        return (
                                                            <div key={prob.mgp} className={`flex flex-col items-center justify-center p-1.5 rounded border ${bgClass}`}>
                                                                <span className={`text-[10px] font-bold ${textClass}`}>
                                                                    {prob.mgp.toLocaleString()}
                                                                </span>
                                                                <span className="text-xs font-mono text-white/70">
                                                                    {prob.percent.toFixed(0)}%
                                                                </span>
                                                            </div>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center py-6 px-2 font-sans overflow-x-hidden pb-20 relative">
                
                {/* Language Switcher */}
                <div className="absolute top-4 right-4 z-40 flex bg-black/40 backdrop-blur-md border border-[#ffffff1a] rounded-full p-1 shadow-lg">
                    {['zh', 'en', 'ja'].map(l => (
                        <button 
                            key={l}
                            onClick={() => setLang(l)}
                            className={`px-3 py-1 rounded-full text-xs font-bold uppercase transition-all ${lang === l ? 'bg-[#d4af37] text-black shadow' : 'text-zinc-400 hover:text-white'}`}
                        >
                            {l === 'zh' ? '繁' : l === 'ja' ? '日' : l}
                        </button>
                    ))}
                </div>

                {/* Header */}
                <div className="w-full max-w-md mb-2 text-center relative shrink-0 mt-8">
                    {/* 背景光暈 */}
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-purple-500/20 blur-[60px] rounded-full pointer-events-none mix-blend-screen"></div>
                    <div className="relative flex flex-col items-center gap-2">
                        <div className="flex items-center gap-3">
                        <Trophy className="w-6 h-6 text-[#fcd34d] drop-shadow-[0_0_5px_rgba(252,211,77,0.8)]" />
                        <h1 className="text-gold text-3xl md:text-4xl font-serif font-extrabold tracking-widest drop-shadow-lg">
                            {t('title')}
                        </h1>
                        <Trophy className="w-6 h-6 text-[#fcd34d] drop-shadow-[0_0_5px_rgba(252,211,77,0.8)]" />
                        </div>
                        <div className="h-[2px] w-32 bg-gradient-to-r from-transparent via-[#d4af37] to-transparent opacity-80"></div>
                    </div>
                </div>

                {/* --- CONTROLS AT TOP (Arcade Buttons) --- */}
                <div className="mb-1 flex flex-col w-full max-w-[320px] gap-3 shrink-0 relative z-20">
                    <div className="flex gap-2">
                        <button 
                            onClick={handleReset}
                            className="flex-1 py-3 btn-3d bg-gradient-to-br from-red-600 to-red-800 border-b-4 border-red-950 rounded-xl text-white font-bold tracking-wider flex items-center justify-center gap-2 active:border-b-0"
                        >
                            <RefreshCw className="w-4 h-4" /> {t('reset')}
                        </button>
                        <button 
                            onClick={() => setShowPayouts(true)}
                            className="flex-1 py-3 btn-3d bg-gradient-to-br from-[#fcd34d] to-[#d4af37] border-b-4 border-[#b45309] rounded-xl text-black font-bold tracking-wider flex items-center justify-center gap-2 active:border-b-0"
                        >
                            <BookOpen className="w-4 h-4" /> {t('payout_btn')}
                        </button>
                    </div>

                    <button 
                        onClick={() => setIsFullFillMode(!isFullFillMode)}
                        className={`
                            w-full py-3 btn-3d rounded-xl font-bold tracking-wider flex items-center justify-center gap-2 border-b-4 active:border-b-0
                            ${isFullFillMode 
                                ? 'bg-gradient-to-br from-blue-600 to-blue-800 border-blue-950 text-white' 
                                : 'bg-zinc-800 border-black text-zinc-400 hover:text-zinc-200'}
                        `}
                    >
                        {isFullFillMode ? <Unlock className="w-4 h-4" /> : <Lock className="w-4 h-4" />}
                        {isFullFillMode ? t('mode_on') : t('mode_off')}
                    </button>

                    <div className="text-center text-[#fcd34d] text-xs mt-1 font-mono font-bold drop-shadow">
                        {t('filled_status').replace('{n}', filledCount)}
                    </div>
                </div>

                {/* Grid */}
                <div className="w-full max-w-[400px] aspect-[4/5] flex flex-col justify-center shrink-0">
                    <div className="grid grid-cols-[3.5rem_1fr_1fr_1fr_3.5rem] gap-2 items-center justify-items-center w-full">
                        <Indicator lineId={6} arrow="↘" /> 
                        <Indicator lineId={3} arrow="⬇" /> 
                        <Indicator lineId={4} arrow="⬇" /> 
                        <Indicator lineId={5} arrow="⬇" /> 
                        <Indicator lineId={7} arrow="↙" /> 

                        <Indicator lineId={0} arrow="➡" />
                        <GameCell idx={0} /> <GameCell idx={1} /> <GameCell idx={2} /> <div />

                        <Indicator lineId={1} arrow="➡" />
                        <GameCell idx={3} /> <GameCell idx={4} /> <GameCell idx={5} /> <div />

                        <Indicator lineId={2} arrow="➡" />
                        <GameCell idx={6} /> <GameCell idx={7} /> <GameCell idx={8} /> <div />
                    </div>
                </div>
                
                {/* Analysis Table */}
                <AnalysisList />

                <div className="mt-8 text-zinc-500 text-[10px] font-mono">
                    {t('ver')}: {BUILD_DATE}
                </div>

                <NumberSelector 
                    isOpen={openSelectorIndex !== null}
                    currentValue={openSelectorIndex !== null ? board[openSelectorIndex] : null}
                    usedNumbers={usedNumbersSet}
                    onSelect={handleSelect}
                    onClose={() => setOpenSelectorIndex(null)}
                    t={t}
                />
                
                <PayoutTableModal 
                    isOpen={showPayouts}
                    onClose={() => setShowPayouts(false)}
                    t={t}
                />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MiniCactpotSolver />);
    </script>
</body>
</html>